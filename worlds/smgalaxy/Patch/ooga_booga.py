import dolphin_memory_engine as dol
import random
import math

file = r"layer{0}\objinfo"

function = b'\x94\x21\xff\xe0\x7c\x08\x02\xa6\x90\x01\x00\x24\x39\x61\x00\x20\x48\x51\x5c\x21\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x7c\x7f\x1b\x78\x83\xbe\x00\x00\x7c\x9e\x23\x78\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x3c\x60\x80\x00\x60\x63\x18\x20\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x7f\xa4\xeb\x78\x60\x00\x00\x00\x60\x00\x00\x00\x48\x51\xce\xb1\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x2c\x03\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x40\x82\x00\x60\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x3c\x60\x80\x00\x60\x63\x18\x30\x60\x00\x00\x00\x60\x00\x00\x00\x38\x9d\xff\xd2\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x48\x51\xce\x61\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x2c\x03\x00\x00\x60\x00\x00\x00\x41\x82\x00\x18\x60\x00\x00\x00\x60\x00\x00\x00\x48\x00\x00\x3c\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x7f\xe3\xfb\x78\x60\x00\x00\x00\x7f\xc4\xf3\x78\x60\x00\x00\x00\x48\x40\x30\x49\x60\x00\x00\x00\x42\x80\x04\xa0\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x3c\x60\x80\x00\x60\x63\x18\x40\x60\x00\x00\x00\x60\x00\x00\x00\x38\x9d\xff\xd2\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x48\x51\xcd\xd1\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x2c\x03\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x40\x82\x00\x40\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x7f\xe3\xfb\x78\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x3c\x80\x80\x00\x60\x84\x18\x00\x80\x84\x00\x00\x60\x00\x00\x00\x48\x40\x2f\xb1\x60\x00\x00\x00\x42\x80\x04\x08\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x3c\x60\x80\x00\x60\x63\x18\x60\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x38\x9d\xff\xd2\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x48\x51\xcd\x45\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x2c\x03\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x40\x82\x00\x34\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x7f\xe3\xfb\x78\x60\x00\x00\x00\x3c\x80\x80\x00\x60\x84\x18\x04\x80\x84\x00\x00\x48\x40\x2f\x31\x60\x00\x00\x00\x42\x80\x03\x88\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x3c\x60\x80\x00\x60\x63\x18\x80\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x38\x9d\xff\xd2\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x48\x51\xcc\xc5\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x2c\x03\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x40\x82\x00\x34\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x7f\xe3\xfb\x78\x60\x00\x00\x00\x3c\x80\x80\x00\x60\x84\x18\x08\x80\x84\x00\x00\x48\x40\x2e\xb1\x60\x00\x00\x00\x42\x80\x03\x08\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x3c\x60\x80\x00\x60\x63\x18\xa0\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x38\x9d\xff\xd2\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x48\x51\xcc\x45\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x2c\x03\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x40\x82\x00\x34\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x7f\xe3\xfb\x78\x60\x00\x00\x00\x3c\x80\x80\x00\x60\x84\x18\x0c\x80\x84\x00\x00\x48\x40\x2e\x31\x60\x00\x00\x00\x42\x80\x02\x88\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x3c\x60\x80\x00\x60\x63\x18\xc0\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x38\x9d\xff\xd2\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x48\x51\xcb\xc5\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x2c\x03\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x40\x82\x00\x34\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x7f\xe3\xfb\x78\x60\x00\x00\x00\x3c\x80\x80\x00\x60\x84\x18\x10\x80\x84\x00\x00\x48\x40\x2d\xb1\x60\x00\x00\x00\x42\x80\x02\x08\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x3c\x60\x80\x00\x60\x63\x18\xe0\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x38\x9d\xff\xd2\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x48\x51\xcb\x45\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x2c\x03\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x40\x82\x00\x34\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x7f\xe3\xfb\x78\x60\x00\x00\x00\x3c\x80\x80\x00\x60\x84\x18\x14\x80\x84\x00\x00\x48\x40\x2d\x31\x60\x00\x00\x00\x42\x80\x01\x88\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x7f\xe3\xfb\x78\x7f\xc4\xf3\x78\x60\x00\x00\x00\x60\x00\x00\x00\x48\x40\x2d\x01\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x60\x04\x00\x01\x60\x00\x00\x00\x60\x03\x00\x01\x60\x00\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x39\x61\x00\x20\x48\x51\x56\x91\x80\x01\x00\x24\x7c\x08\x03\xa6\x38\x21\x00\x20\x4e\x80\x00\x20'

galaxy_names = [b'MiniTriLegLv1Galaxy',
                b'MiniHoneyBeeKingdomGalaxy',
                b'MiniEggStarGalaxy',
                b'MiniFlipPanelExGalaxy',
                b'MiniSurfingLv1Galaxy',
                b'MiniKoopaBattleVs1Galaxy',
                b'MiniStarDustGalaxy',
                b'MiniBattleShipGalaxy',
                b'MiniTamakoroExLv1Galaxy',
                b'MiniBreakDownPlanetGalaxy',
                b'MiniKoopaJrShipLv1Galaxy',
                b'MiniPhantomGalaxy',
                b'MiniHeavenlyBeachGalaxy',
                b'MiniCubeBubbleExLv1Galaxy',
                b'MiniOceanFloaterLandGalaxy',
                b'MiniIceVolcanoGalaxy',
                b'MiniCosmosGardenGalaxy',
                b'MiniSandClockGalaxy',
                b'MiniKoopaBattleVs2Galaxy',
                b'MiniHoneyBeeExGalaxy', 
                b'MiniOceanRingGalaxy',
                b'MiniFactoryGalaxy',
                b'MiniFloaterOtaKingGalaxy',
                b'MiniReverseKingdomGalaxy',
                b'MiniSkullSharkGalaxy',
                b'MiniCannonFleetGalaxy',
                b'MiniDarkRoomGalaxy',
                b'MiniOceanPhantomCaveGalaxy',
                b'MiniHellProminenceGalaxy']

layers = ['a','b','c','d','e','f']

random.shuffle(galaxy_names)
random.shuffle(galaxy_names)
random.shuffle(galaxy_names)
random.shuffle(galaxy_names)
random.shuffle(galaxy_names)

name_offset = 120

def create_new_files():
    for layer in layers:
        with open(file.format(layer), 'rb') as f:
            random.shuffle(galaxy_names)
            random.shuffle(galaxy_names)
            random.shuffle(galaxy_names)
            random.shuffle(galaxy_names)
            random.shuffle(galaxy_names)
            
            rows = int.from_bytes(f.read(4))
            cols = int.from_bytes(f.read(4))
            offset = int.from_bytes(f.read(4))
            size = int.from_bytes(f.read(4))
        
            f.read(12 * cols)
            f.read(rows * size)
        
            string_start = offset + rows * size
        
            strings = f.read().split(b'\x00')
        
            lengths = [len(i) for i in strings]
            old_offsets = [sum(lengths[:i]) + i for i in range(len(lengths))]
            
            count = 0
            for i, string in enumerate(strings):
                if b'Mini' in string:
                    strings[i] = galaxy_names[count]
                    count += 1
        
            string_concat = b'\x00'.join(strings[:-1])+b'\x00'
        
            new_offsets = []
        
            for string in strings[:-1]:
                new_offsets.append(string_concat.index(string+b'\x00'))
        
            write = b''
            f.seek(0)
            write += f.read(16 + 12 * cols + rows * size)
            write += string_concat
        
            missing = math.ceil(len(write)/32) * 32 - len(write)
            write += b'@' * missing
        
            with open(layer, 'wb') as fw:
                fw.write(write)
            
                for row in range(rows):
                    f.seek(offset + row * size + name_offset)
                    old_offset = int.from_bytes(f.read(4))
                    index = old_offsets.index(old_offset)
                    new_offset = new_offsets[index]
                    
                    fw.seek(offset + row * size + name_offset)
                    fw.write(int.to_bytes(new_offset, 4))
    return layers

if __name__ == "__main__":
    dol.hook()

    if dol.is_hooked(): 
    
        PC = 0x817e9000
    
        for i, layer in enumerate(layers):
            with open(layer, 'rb') as f:
                dol.write_word(0x80001800 + i*4, PC)
                data = f.read()
                dol.write_bytes(PC, data)
                PC += len(data)
    
        PC = 0x80001820
    
        dol.write_bytes(PC, 'objinfo'.encode('utf-8'))
    
        PC = 0x80001830
    
        dol.write_bytes(PC, 'common'.encode('utf-8'))
    
        PC = 0x80001840
    
        for layer in layers:
            dol.write_bytes(PC, 'layer{0}'.format(layer).encode('utf-8'))
            PC += 0x20
    
        PC = 0x80001900
    
        dol.write_bytes(PC, function)
    
        PC = 0x80347a3c
    
        dol.write_bytes(PC, b'\x4b\xcb\x9e\xc5')
    
        print("Succesfully injected")

    else:
        print("Failed to hook")

    dol.un_hook()
