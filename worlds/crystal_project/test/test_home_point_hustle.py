import logging
from typing import Tuple

from BaseClasses import CollectionState
from .bases import CrystalProjectTestBase
from .. import display_region_subregions_dictionary
from ..constants.ap_regions import *
from ..constants.display_regions import *
from ..constants.home_points import *
from ..constants.region_passes import *


class TestHomePointHustle(CrystalProjectTestBase):
    options = {
        "level_gating": 0,
        "home_point_hustle": 1
    }

    def test_home_points_giving_access_to_correct_region(self):
        home_point_name_to_ap_region_dict: dict[str, str] = {
            # Beginner
            HOMEPOINT_AP_SPAWN_NAME: HOMEPOINT_AP_SPAWN_AP_REGION,
            HOMEPOINT_OLD_NANS_WATERING_HOLE_NAME: HOMEPOINT_OLD_NANS_WATERING_HOLE_AP_REGION,
            HOMEPOINT_THE_PALE_GROTTO_ENTRANCE_NAME: HOMEPOINT_THE_PALE_GROTTO_ENTRANCE_AP_REGION,
            HOMEPOINT_SOILED_DEN_NAME: HOMEPOINT_SOILED_DEN_AP_REGION,
            HOMEPOINT_FISH_HATCHERY_NAME: HOMEPOINT_FISH_HATCHERY_AP_REGION,
            HOMEPOINT_CABIN_ON_THE_CLIFF_NAME: HOMEPOINT_CABIN_ON_THE_CLIFF_AP_REGION,
            HOMEPOINT_DELENDE_FALLS_NAME: HOMEPOINT_DELENDE_FALLS_AP_REGION,
            HOMEPOINT_DELENDE_PEAK_NAME: HOMEPOINT_DELENDE_PEAK_AP_REGION,
            HOMEPOINT_MERCURY_SHRINE_NAME: HOMEPOINT_MERCURY_SHRINE_AP_REGION,
            HOMEPOINT_THE_PALE_GROTTO_RUINS_NAME: HOMEPOINT_THE_PALE_GROTTO_RUINS_AP_REGION,
            HOMEPOINT_SEASIDE_CLIFFS_CAMP_NAME: HOMEPOINT_SEASIDE_CLIFFS_AP_REGION,
            HOMEPOINT_YAMAGAWA_MA_SUMMIT_NAME: HOMEPOINT_YAMAGAWA_MA_SUMMIT_AP_REGION,
            HOMEPOINT_PROVING_MEADOWS_CAMP_NAME: HOMEPOINT_PROVING_MEADOWS_CAMP_AP_REGION,
            HOMEPOINT_SKUMPARADISE_ENTRANCE_NAME: HOMEPOINT_SKUMPARADISE_ENTRANCE_AP_REGION,
            HOMEPOINT_SKUMPARADISE_DEPTHS_NAME: HOMEPOINT_SKUMPARADISE_DEPTHS_AP_REGION,
            # Advanced
            HOMEPOINT_SKUMPARADISE_EXIT_NAME: HOMEPOINT_SKUMPARADISE_EXIT_AP_REGION,
            HOMEPOINT_GAEA_SHRINE_NAME: HOMEPOINT_GAEA_SHRINE_AP_REGION,
            HOMEPOINT_EAST_MARKET_DISTRICT_NAME: HOMEPOINT_EAST_MARKET_DISTRICT_AP_REGION,
            HOMEPOINT_BULLETIN_SQUARE_NAME: HOMEPOINT_BULLETIN_SQUARE_AP_REGION,
            HOMEPOINT_KNOW_IT_ALL_DUCKS_HOUSE_NAME: HOMEPOINT_KNOW_IT_ALL_DUCKS_HOUSE_AP_REGION,
            HOMEPOINT_WEST_MARKET_DISTRICT_NAME: HOMEPOINT_WEST_MARKET_DISTRICT_AP_REGION,
            HOMEPOINT_TRAINING_GROUNDS_NAME: HOMEPOINT_TRAINING_GROUNDS_AP_REGION,
            HOMEPOINT_BOOMER_SOCIETY_NAME: HOMEPOINT_BOOMER_SOCIETY_AP_REGION,
            HOMEPOINT_QUINTAR_ENTHUSIASTS_HOUSE_NAME: HOMEPOINT_QUINTAR_ENTHUSIASTS_HOUSE_AP_REGION,
            HOMEPOINT_RENT_A_QUINTAR_NAME: HOMEPOINT_RENT_A_QUINTAR_AP_REGION,
            HOMEPOINT_QUINTAR_SANCTUM_NAME: HOMEPOINT_QUINTAR_SANCTUM_AP_REGION,
            HOMEPOINT_QUINTAR_NAMEKO_NAME: HOMEPOINT_QUINTAR_NAMEKO_AP_REGION,
            HOMEPOINT_CAPITAL_JAIL_ENTRANCE_NAME: HOMEPOINT_CAPITAL_JAIL_ENTRANCE_AP_REGION,
            HOMEPOINT_CAPITAL_JAIL_DARK_WING_NAME: HOMEPOINT_CAPITAL_JAIL_DARK_WING_AP_REGION,
            HOMEPOINT_CAPITAL_PIPELINE_NAME: HOMEPOINT_CAPITAL_PIPELINE_AP_REGION,
            HOMEPOINT_EAST_CAPITAL_PIPELINE_NAME: HOMEPOINT_EAST_CAPITAL_PIPELINE_AP_REGION,
            HOMEPOINT_OKIMOTO_N_S_BASE_NAME: HOMEPOINT_OKIMOTO_N_S_BASE_AP_REGION,
            HOMEPOINT_NINJA_YASHIKI_NAME: HOMEPOINT_NINJA_YASHIKI_AP_REGION,
            HOMEPOINT_SALMON_PASS_ENTRANCE_NAME: HOMEPOINT_SALMON_PASS_ENTRANCE_AP_REGION,
            HOMEPOINT_SALMON_SHACK_NAME: HOMEPOINT_SALMON_SHACK_AP_REGION,
            HOMEPOINT_LABYRINTH_ENCAMPMENT_NAME: HOMEPOINT_LABYRINTH_ENCAMPMENT_AP_REGION,
            HOMEPOINT_SARA_SARA_BAZAAR_PORT_NAME: HOMEPOINT_SARA_SARA_BAZAAR_PORT_AP_REGION,
            HOMEPOINT_POKO_POKO_WEST_GATE_NAME: HOMEPOINT_POKO_POKO_WEST_GATE_AP_REGION,
            HOMEPOINT_POKO_POKO_EAST_GATE_NAME: HOMEPOINT_POKO_POKO_EAST_GATE_AP_REGION,
            HOMEPOINT_IBEKS_CAVE_NAME: HOMEPOINT_IBEKS_CAVE_AP_REGION,
            HOMEPOINT_BEACH_BIRDS_NEST_NAME: HOMEPOINT_BEACH_BIRDS_NEST_AP_REGION,
            HOMEPOINT_ANCIENT_RESERVOIR_ENTRANCE_NAME: HOMEPOINT_ANCIENT_RESERVOIR_ENTRANCE_AP_REGION,
            HOMEPOINT_MAIN_RESERVOIR_CHAMBER_NAME: HOMEPOINT_MAIN_RESERVOIR_CHAMBER_AP_REGION,
            # Expert
            HOMEPOINT_SAILORS_RAFT_NAME: HOMEPOINT_SAILORS_RAFT_AP_REGION,
            HOMEPOINT_SHOUDU_FIELDS_NAME: HOMEPOINT_SHOUDU_FIELDS_AP_REGION,
            HOMEPOINT_SHOUDU_MARKET_NAME: HOMEPOINT_SHOUDU_MARKET_AP_REGION,
            HOMEPOINT_SHOUDU_PORT_NAME: HOMEPOINT_SHOUDU_PORT_AP_REGION,
            HOMEPOINT_SHANTY_INN_NAME: HOMEPOINT_SHANTY_INN_AP_REGION,
            HOMEPOINT_SKY_ARENA_NAME: HOMEPOINT_SKY_ARENA_AP_REGION,
            HOMEPOINT_PRIZE_COUNTER_NAME: HOMEPOINT_PRIZE_COUNTER_AP_REGION,
            HOMEPOINT_SHOUDU_ELEVATOR_NAME: HOMEPOINT_SHOUDU_ELEVATOR_AP_REGION,
            HOMEPOINT_THE_UNDERCITY_NAME: HOMEPOINT_THE_UNDERCITY_AP_REGION,
            HOMEPOINT_GANYMEDE_SHRINE_NAME: HOMEPOINT_GANYMEDE_SHRINE_AP_REGION,
            HOMEPOINT_BEAURIOR_ROCK_NAME: HOMEPOINT_BEAURIOR_ROCK_AP_REGION,
            HOMEPOINT_BEAURIOR_VOLCANO_PEAK_NAME: HOMEPOINT_BEAURIOR_VOLCANO_PEAK_AP_REGION,
            HOMEPOINT_BOSS_ROOM_NAME: HOMEPOINT_BOSS_ROOM_AP_REGION,
            HOMEPOINT_DIONE_SHRINE_NAME: HOMEPOINT_DIONE_SHRINE_AP_REGION,
            HOMEPOINT_FLYERS_LOOKOUT_NAME: HOMEPOINT_FLYERS_LOOKOUT_AP_REGION,
            HOMEPOINT_SEQUOIA_ATHENAEUM_NAME: HOMEPOINT_SEQUOIA_ATHENAEUM_AP_REGION,
            HOMEPOINT_ICE_PASS_NAME: HOMEPOINT_ICE_PASS_AP_REGION,
            HOMEPOINT_TALL_TALL_SOUVENIR_SHOP_NAME: HOMEPOINT_TALL_TALL_SOUVENIR_SHOP_AP_REGION,
            HOMEPOINT_LANDS_END_COTTAGE_NAME: HOMEPOINT_LANDS_END_COTTAGE_AP_REGION,
            HOMEPOINT_SLIP_GLIDE_RIDE_EXIT_NAME: HOMEPOINT_SLIP_GLIDE_RIDE_EXIT_AP_REGION,
            HOMEPOINT_ICE_FISHERS_HUT_NAME: HOMEPOINT_ICE_FISHERS_HUT_AP_REGION,
            HOMEPOINT_TRITON_SHRINE_NAME: HOMEPOINT_TRITON_SHRINE_AP_REGION,
            HOMEPOINT_TALL_TALL_HEIGHTS_NAME: HOMEPOINT_TALL_TALL_HEIGHTS_AP_REGION,
            HOMEPOINT_SUMMIT_SHRINE_NAME: HOMEPOINT_SUMMIT_SHRINE_AP_REGION,
            HOMEPOINT_SLIP_GLIDE_RIDE_ENTRANCE_NAME: HOMEPOINT_SLIP_GLIDE_RIDE_ENTRANCE_AP_REGION,
            HOMEPOINT_EAST_RAMPARTS_NAME: HOMEPOINT_EAST_RAMPARTS_AP_REGION,
            HOMEPOINT_WEST_RAMPARTS_NAME: HOMEPOINT_WEST_RAMPARTS_AP_REGION,
            HOMEPOINT_THE_CHALICE_OF_TAR_NAME: HOMEPOINT_THE_CHALICE_OF_TAR_AP_REGION,
            HOMEPOINT_EUROPA_SHRINE_NAME: HOMEPOINT_EUROPA_SHRINE_AP_REGION,
            HOMEPOINT_EACLANEYA_ENTRANCE_NAME: HOMEPOINT_EACLANEYA_ENTRANCE_AP_REGION,
            HOMEPOINT_SALMON_ROOM_NAME: HOMEPOINT_SALMON_ROOM_AP_REGION,
            HOMEPOINT_NEPTUNE_SHRINE_NAME: HOMEPOINT_NEPTUNE_SHRINE_AP_REGION,
            HOMEPOINT_PLATFORM_A_NAME: HOMEPOINT_PLATFORM_A_AP_REGION,
            # End-Game
            HOMEPOINT_ANCIENT_LABYRINTH_CORE_NAME: HOMEPOINT_ANCIENT_LABYRINTH_CORE_AP_REGION,
            HOMEPOINT_TOP_OF_THE_SEQUOIA_NAME: HOMEPOINT_TOP_OF_THE_SEQUOIA_AP_REGION,
            HOMEPOINT_CASTLE_SEQUOIA_FOYER_NAME: HOMEPOINT_CASTLE_SEQUOIA_FOYER_AP_REGION,
            HOMEPOINT_ASTLEYS_SHRINE_NAME: HOMEPOINT_ASTLEYS_SHRINE_AP_REGION,
            HOMEPOINT_ASTLEYS_KEEP_NAME: HOMEPOINT_ASTLEYS_KEEP_AP_REGION,
            HOMEPOINT_DISCIPLINE_HOLLOW_NAME: HOMEPOINT_DISCIPLINE_HOLLOW_AP_REGION
        }
        expected_entrances_list: list[str] = []
        entrances_not_expected_list: list[str] = []
        display_entrances_not_expected_list = self.multiworld.worlds[self.player].included_regions
        # not removing Modded Zone bc this test does not have Use Mods enabled
        display_entrances_not_expected_list.remove(MENU_DISPLAY_NAME)

        for included_display_region in display_entrances_not_expected_list:
            for included_ap_region in display_region_subregions_dictionary[included_display_region]:
                for entrance in self.multiworld.worlds[self.player].get_region(MENU_AP_REGION).exits:
                    if MENU_AP_REGION + " -> " + included_ap_region == entrance.name:
                        entrances_not_expected_list.append(included_ap_region)
                        break

        self.assert_region_entrances(MENU_AP_REGION, reachable_regions=tuple(expected_entrances_list),
                                     unreachable_regions=tuple(entrances_not_expected_list))

        pristine_state = CollectionState(self.multiworld)
        pristine_entrances_not_expected_list = entrances_not_expected_list

        for key in home_point_name_to_ap_region_dict:
            self.multiworld.state = pristine_state.copy()
            expected_entrances_list: list[str] = []
            entrances_not_expected_list = pristine_entrances_not_expected_list.copy()

            self.collect(self.get_item_by_name(key))
            expected_entrances_list.append(home_point_name_to_ap_region_dict[key])
            entrances_not_expected_list.remove(home_point_name_to_ap_region_dict[key])

            self.assertTrue(self.can_reach_entrance(MENU_AP_REGION + " -> " + home_point_name_to_ap_region_dict[key]), msg="Test Can Reach Entrance " + home_point_name_to_ap_region_dict[key] + " using " + key)

            self.assert_region_entrances(MENU_AP_REGION, reachable_regions=tuple(expected_entrances_list),
                                         unreachable_regions=tuple(entrances_not_expected_list))